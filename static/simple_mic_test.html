<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>ç®€å•éº¦å…‹é£æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
        }

        .recording {
            background: red;
            color: white;
        }

        canvas {
            border: 1px solid #ccc;
            margin: 20px 0;
            background: #000;
        }

        #info {
            background: #f0f0f0;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>ğŸ¤ éº¦å…‹é£è¯Šæ–­å·¥å…·</h1>

    <button id="testBtn" onclick="toggleTest()">å¼€å§‹æµ‹è¯•</button>

    <canvas id="canvas" width="700" height="150"></canvas>

    <div id="info">
        <h3>çŠ¶æ€ä¿¡æ¯</h3>
        <div id="status">æœªå¼€å§‹</div>
    </div>

    <div class="log" id="log"></div>

    <script>
        let isRecording = false;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let animationId = null;

        function log(msg) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${msg}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }

        async function toggleTest() {
            const btn = document.getElementById('testBtn');

            if (isRecording) {
                // åœæ­¢
                log('â¹ï¸ åœæ­¢æµ‹è¯•');
                isRecording = false;
                btn.classList.remove('recording');
                btn.textContent = 'å¼€å§‹æµ‹è¯•';

                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                if (microphone && microphone.mediaStream) {
                    microphone.mediaStream.getTracks().forEach(track => track.stop());
                }
                if (audioContext) {
                    audioContext.close();
                }

                document.getElementById('status').textContent = 'å·²åœæ­¢';
                return;
            }

            // å¼€å§‹
            try {
                log('ğŸ¤ è¯·æ±‚éº¦å…‹é£æƒé™...');
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                log('âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸ');

                // è·å–éŸ³é¢‘è½¨é“ä¿¡æ¯
                const audioTrack = stream.getAudioTracks()[0];
                const settings = audioTrack.getSettings();
                log(`éº¦å…‹é£: ${audioTrack.label}`);
                log(`é‡‡æ ·ç‡: ${settings.sampleRate || 'æœªçŸ¥'} Hz`);
                log(`å£°é“æ•°: ${settings.channelCount || 'æœªçŸ¥'}`);

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                log(`AudioContext çŠ¶æ€: ${audioContext.state}`);
                log(`AudioContext é‡‡æ ·ç‡: ${audioContext.sampleRate} Hz`);

                // æ¢å¤ AudioContextï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ï¼‰
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                    log(`AudioContext å·²æ¢å¤: ${audioContext.state}`);
                }

                // åˆ›å»ºèŠ‚ç‚¹
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.3;

                // è¿æ¥ï¼šmicrophone -> analyser
                microphone.connect(analyser);

                log('âœ… éŸ³é¢‘èŠ‚ç‚¹å·²è¿æ¥');
                log(`Analyser FFTå¤§å°: ${analyser.fftSize}`);
                log(`Analyser é¢‘ç‡ bin æ•°: ${analyser.frequencyBinCount}`);

                isRecording = true;
                btn.classList.add('recording');
                btn.textContent = 'åœæ­¢æµ‹è¯•';

                microphone.mediaStream = stream;

                // å¼€å§‹å¯è§†åŒ–
                visualize();

            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.name} - ${error.message}`);
                document.getElementById('status').textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        function visualize() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            let frameCount = 0;

            function draw() {
                if (!isRecording) return;

                animationId = requestAnimationFrame(draw);
                frameCount++;

                // è·å–æ•°æ®
                analyser.getByteTimeDomainData(dataArray);

                // ç»˜åˆ¶æ³¢å½¢
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.lineWidth = 2;
                ctx.strokeStyle = '#0f0';
                ctx.beginPath();

                const sliceWidth = canvas.width / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * canvas.height / 2;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();

                // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                let min = 255, max = 0, sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    const val = dataArray[i];
                    if (val < min) min = val;
                    if (val > max) max = val;
                    sum += Math.abs(val - 128);
                }

                const range = max - min;
                const avg = sum / bufferLength;
                const peakPercent = Math.round((range / 255) * 100);
                const avgPercent = Math.round((avg / 128) * 100);

                // æ¯30å¸§è®°å½•ä¸€æ¬¡
                if (frameCount % 30 === 0) {
                    log(`ğŸ“Š Min: ${min}, Max: ${max}, èŒƒå›´: ${range}, å³°å€¼: ${peakPercent}%, å¹³å‡: ${avgPercent}%`);
                }

                // æ›´æ–°çŠ¶æ€
                let statusColor = '#ff0000';
                let statusText = 'âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å£°éŸ³';

                if (range > 200) {
                    statusColor = '#00ff00';
                    statusText = 'âœ… éŸ³é‡å¾ˆå¥½ï¼';
                } else if (range > 100) {
                    statusColor = '#00aa00';
                    statusText = 'âœ… éŸ³é‡æ­£å¸¸';
                } else if (range > 30) {
                    statusColor = '#ffaa00';
                    statusText = 'âš ï¸ éŸ³é‡åå°';
                } else if (range > 5) {
                    statusColor = '#ff6600';
                    statusText = 'âš ï¸ éŸ³é‡å¤ªå°';
                }

                document.getElementById('status').innerHTML = `
                    <strong style="color:${statusColor}">${statusText}</strong><br>
                    åŸå§‹èŒƒå›´: ${min} - ${max} (å·®å€¼: ${range})<br>
                    å³°å€¼ç™¾åˆ†æ¯”: ${peakPercent}%<br>
                    å¹³å‡åç§»: ${avgPercent}%<br>
                    å¸§æ•°: ${frameCount}
                `;
            }

            draw();
        }

        log('ğŸš€ é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®');
    </script>
</body>

</html>