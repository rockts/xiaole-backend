# 任务管理基础规则

## 任务识别

### 什么是复杂任务？

复杂任务具有以下特征：
1. 需要多个步骤才能完成
2. 涉及多个工具或操作
3. 步骤之间有依赖关系
4. 需要一定时间完成
5. 涉及购物、办事、出行等需要规划或记录的事项

### 任务识别示例

**✅ 是任务**：
- "帮我准备周末的野餐"（需要查天气、列物品、设提醒）
- "帮我规划下周的学习计划"（需要多步分析和安排）
- "去买杯冰美式"（购物任务，可能需要导航或记录）
- "带份早餐"（办事任务）

**❌ 不是任务**：
- "今天天气怎么样"（单个查询）
- "提醒我明天9点开会"（单个提醒）
- "现在几点"（简单查询）

### 识别置信度

- `confidence >= 0.7`：确认为任务，执行拆解
- `confidence < 0.7`：不确认为任务，按普通对话处理

## 任务拆解

### 拆解原则

1. **步骤具体可执行**：每个步骤都要明确、可操作
2. **逻辑顺序清晰**：步骤之间要有依赖关系
3. **变量具体化**：所有变量必须替换为具体值
   - ❌ 错误：`{"city": "当前城市"}`
   - ✅ 正确：`{"city": "天水"}` 或 `{"city": "北京"}`
4. **工具参数完整**：需要调用工具的要标明工具名和完整参数

### 步骤类型

- `tool_call`：调用工具
- `user_confirm`：需要用户确认
- `wait`：等待条件
- `info`：信息展示

### 时间描述规则

**重要**：reminder 工具的 `time_desc` 参数：
- ✅ 使用用户的自然语言描述（如"明天早上8点"）
- ❌ 不要转换为 UTC 时间或具体日期
- 工具会自动解析自然语言时间描述

### 拆解示例

**任务**："准备周末野餐"（用户在天水）

```json
{
  "steps": [
    {
      "step_num": 1,
      "description": "查询天水周末天气预报",
      "action_type": "tool_call",
      "action_params": {
        "tool_name": "weather",
        "params": {"city": "天水", "query_type": "7d"},
        "notes": "确定天气情况"
      }
    },
    {
      "step_num": 2,
      "description": "列出野餐所需物品清单",
      "action_type": "info",
      "action_params": {
        "notes": "生成物品清单供用户参考"
      }
    },
    {
      "step_num": 3,
      "description": "设置购物提醒",
      "action_type": "user_confirm",
      "action_params": {
        "question": "是否需要设置购物提醒?",
        "if_yes": "tool_call:reminder"
      }
    },
    {
      "step_num": 4,
      "description": "创建购物提醒",
      "action_type": "tool_call",
      "action_params": {
        "tool_name": "reminder",
        "params": {
          "content": "购买野餐用品：餐垫、水果、饮料",
          "time_desc": "明天早上9点"
        },
        "notes": "用户确认后执行"
      }
    }
  ]
}
```

## 任务执行

### 执行流程

1. **创建任务**：在数据库中创建任务记录
2. **创建步骤**：为每个拆解步骤创建记录
3. **执行步骤**：按顺序执行每个步骤
4. **状态更新**：根据执行结果更新步骤和任务状态

### 步骤状态

- `pending`：待执行
- `running`：执行中
- `completed`：已完成
- `waiting`：等待用户确认
- `failed`：执行失败

### 任务状态

- `pending`：待执行
- `running`：执行中
- `waiting`：等待用户确认
- `completed`：已完成
- `failed`：执行失败
- `cancelled`：已取消

### 用户确认处理

当步骤类型为 `user_confirm` 时：
1. 任务进入 `waiting` 状态
2. 等待用户回复
3. 分析用户意图：
   - `confirmed`：确认，继续执行
   - `rejected`：拒绝，终止任务
   - `unrelated`：无关内容，保持等待

### 任务恢复

如果任务处于 `waiting` 状态：
1. 检查用户输入是否为确认/拒绝
2. 如果是确认，标记步骤完成并继续执行
3. 如果是拒绝，终止任务
4. 如果是无关内容，保持等待状态

## 任务去重

### 防重复创建

- 检查最近1分钟内是否有相同标题的任务
- 如果有，跳过创建，返回提示

### 去重逻辑

```python
# 检查最近任务
recent_tasks = task_manager.get_tasks_by_user(user_id, limit=5)

# 检查1分钟内创建的同名任务
for task in recent_tasks:
    if (task['title'] == new_title and 
        (now - task['created_at']).total_seconds() < 60):
        # 跳过创建
        return {'success': False, 'error': '任务已存在'}
```

## 错误处理

### 步骤执行失败

- 记录错误信息
- 更新步骤状态为 `failed`
- 根据任务配置决定是否继续执行后续步骤

### 任务执行失败

- 更新任务状态为 `failed`
- 记录失败原因
- 通知用户（通过对话回复）

## 最佳实践

1. **任务识别要准确**：避免将简单查询误判为任务
2. **拆解要细致**：确保每个步骤都可执行
3. **变量要具体**：不要使用"当前城市"等占位符
4. **时间要自然**：使用用户原话的时间描述
5. **确认要明确**：需要用户确认的步骤要清晰说明
6. **错误要处理**：每个步骤都要有错误处理机制

## 注意事项

1. **不要重复创建**：检查最近任务避免重复
2. **不要过度拆解**：简单操作不要拆成多个步骤
3. **不要假设信息**：不知道的信息要询问用户或使用默认值
4. **不要忽略确认**：需要用户确认的步骤必须等待
5. **不要忘记恢复**：任务等待时要检查用户输入

