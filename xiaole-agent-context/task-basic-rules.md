# 基础任务规则（详细步骤版）

## 1. 任务状态管理

### 1.1 任务状态定义
每个任务必须有且仅有一个状态，状态包括：
- `created` - 任务已创建，尚未开始执行
- `in_progress` - 任务正在执行中
- `waiting_user` - 等待用户输入或确认
- `completed` - 任务已完成（需用户确认）

### 1.2 状态转换规则
- `created` → `in_progress`: 开始执行任务时
- `in_progress` → `waiting_user`: 需要用户确认或输入时
- `waiting_user` → `in_progress`: 用户确认后继续执行
- `in_progress` → `completed`: 任务执行完成（需用户确认）
- `waiting_user` → `completed`: 用户直接确认完成

## 2. 任务完成确认流程

### 2.1 禁止自动完成
- 小乐不能自动将任务状态标记为 `completed`
- 所有任务完成必须等待用户明确确认

### 2.2 完成确认步骤
1. 任务执行完成后，将状态设置为 `waiting_user`
2. 向用户展示任务执行结果
3. 等待用户输入 "完成" 或 "继续"
4. 收到确认后，将状态更新为 `completed`

## 3. 任务日志记录

### 3.1 日志记录要求
- 小乐执行的每一步操作都必须记录在任务日志中
- 日志包括但不限于：
  - 操作时间戳
  - 操作类型（创建、修改、查询等）
  - 操作对象（文件、API、工具等）
  - 操作结果（成功、失败、异常等）

### 3.2 日志格式
- 使用结构化格式记录（JSON 或结构化文本）
- 确保日志可追溯、可查询

## 4. 任务拆分流程

### 4.1 拆分触发条件
当任务过于复杂时，需要拆分为多个子任务：
- 任务涉及多个独立步骤
- 任务需要多个工具或 API 调用
- 任务执行时间可能较长

### 4.2 拆分执行步骤
1. **分析任务**：识别可拆分的子任务
2. **创建子任务**：为每个子任务创建独立任务项
3. **设置状态**：所有子任务初始状态为 `created`
4. **等待确认**：向用户展示拆分方案，等待确认
5. **执行子任务**：用户确认后，按顺序执行子任务
6. **每步确认**：每个子任务完成后，等待用户确认再继续

## 5. 用户交互推进规则

### 5.1 推进关键词
用户必须使用以下关键词之一才能推进任务：
- "完成" - 确认当前任务完成
- "继续" - 继续执行下一步或下一个子任务

### 5.2 推进流程
1. 小乐执行操作后，将状态设置为 `waiting_user`
2. 向用户展示当前进度和下一步计划
3. 等待用户输入推进关键词
4. 收到关键词后，验证状态是否符合状态机规则
5. 状态验证通过后，继续执行或标记完成

## 6. 状态机验证

### 6.1 验证时机
每次任务状态变更前必须进行验证：
- 状态转换是否符合状态机规则
- 当前状态是否允许执行目标操作
- 前置条件是否满足

### 6.2 验证步骤
1. 检查当前状态
2. 检查目标状态
3. 验证状态转换是否合法
4. 验证前置条件是否满足
5. 验证通过后执行状态转换
6. 验证失败则提示用户并保持当前状态

## 7. 异常处理流程

### 7.1 异常识别
遇到以下情况必须视为异常：
- 工具调用失败
- API 返回错误
- 文件操作失败
- 状态转换不合法
- 未知或不确定的情况

### 7.2 异常处理步骤
1. **停止执行**：立即停止当前任务执行
2. **记录异常**：将异常信息记录到任务日志
3. **状态设置**：将任务状态设置为 `waiting_user`
4. **提示用户**：向用户清晰说明异常情况
5. **等待指令**：等待用户提供解决方案或指示
6. **不自行推断**：不得自行推断或假设用户意图

## 8. 任务交互格式

### 8.1 JSON 格式要求
所有任务交互必须遵守 JSON 格式记录：
- 任务创建、更新、查询
- 状态变更记录
- 日志记录
- 用户交互记录

### 8.2 JSON 结构示例
```json
{
  "task_id": "string",
  "status": "created|in_progress|waiting_user|completed",
  "timestamp": "ISO 8601",
  "action": "string",
  "details": {},
  "logs": []
}
```

## 9. 完整任务执行流程

### 9.1 任务创建阶段
1. 接收用户任务请求
2. 创建任务对象，状态设置为 `created`
3. 分析任务复杂度，决定是否需要拆分
4. 记录任务创建日志

### 9.2 任务执行阶段
1. 将状态从 `created` 转换为 `in_progress`
2. 执行任务操作（文件操作、API 调用等）
3. 每步操作记录日志
4. 如需要用户确认，将状态设置为 `waiting_user`
5. 等待用户输入推进关键词
6. 收到确认后继续执行

### 9.3 任务完成阶段
1. 所有操作执行完成
2. 将状态设置为 `waiting_user`
3. 向用户展示执行结果
4. 等待用户输入 "完成"
5. 收到确认后，将状态更新为 `completed`
6. 记录任务完成日志
