# 开发规范

## 代码风格

### Python 代码规范
- 遵循 PEP 8 规范
- 使用类型提示（Type Hints）
- 函数和类添加文档字符串（docstring）
- 使用有意义的变量和函数名

### 文件组织
- 模块化设计，每个功能独立文件
- 工具放在 `tools/` 目录
- 路由放在 `routers/` 目录
- 数据库迁移放在 `db_migrations/` 目录

## 错误处理

### 异常处理原则
- 使用 `try-except` 捕获异常
- 记录详细的错误日志
- 不暴露敏感信息给用户
- 使用装饰器 `@handle_api_errors` 统一处理 API 错误

### 日志规范
- 使用 `logger` 模块记录日志
- 日志级别：
  - `logger.info()`：正常流程信息
  - `logger.warning()`：警告信息
  - `logger.error()`：错误信息
  - `logger.debug()`：调试信息
- 重要操作添加 emoji 标记便于识别（✅ ❌ ⚠️ 🔧 📚 等）

## 数据库操作

### 迁移管理
- 所有数据库结构变更必须通过迁移文件
- 迁移文件命名：`XXX_description.sql`
- 迁移文件放在 `db_migrations/` 目录
- 迁移文件必须可重复执行（幂等性）

### 查询优化
- 使用索引优化查询
- 避免 N+1 查询问题
- 合理使用 `limit` 限制返回数量
- 长时间运行的查询添加超时控制

## API 设计

### 路由规范
- RESTful 风格
- 使用 FastAPI 的路由装饰器
- 参数验证使用 Pydantic 模型
- 返回统一的 JSON 格式

### 响应格式
```python
{
    "success": bool,
    "data": any,
    "error": str (可选),
    "message": str (可选)
}
```

## 工具开发

### 工具注册
- 所有工具必须继承 `BaseTool` 或实现标准接口
- 在 `agent.py` 的 `_register_tools()` 方法中注册
- 工具必须提供清晰的描述和参数说明

### 工具执行
- 支持异步执行
- 提供错误处理和重试机制
- 返回统一的工具结果格式

## 测试

### 测试原则
- 关键功能必须有测试
- 测试文件命名：`test_*.py`
- 使用 pytest 框架
- 测试应该独立、可重复

## 性能优化

### 响应时间
- 普通对话响应时间 < 3 秒
- 工具调用响应时间 < 5 秒
- 超过阈值记录警告日志

### 资源使用
- 合理使用缓存
- 避免不必要的数据库查询
- 控制记忆召回数量（避免 token 消耗过大）

## 安全规范

### 敏感信息
- 不在代码中硬编码密钥
- 使用环境变量存储配置
- 不在日志中输出敏感信息

### 输入验证
- 所有用户输入必须验证
- 防止 SQL 注入（使用参数化查询）
- 防止 XSS 攻击（前端处理）

## Git 工作流

### 提交规范
- 提交信息清晰描述变更内容
- 使用有意义的提交信息
- 相关变更放在同一提交

### 分支管理
- `main` 分支：生产环境代码
- 功能开发创建 feature 分支
- 修复问题创建 fix 分支

## 文档

### 代码文档
- 所有公共函数和类必须有文档字符串
- 复杂逻辑添加注释说明
- README.md 保持更新

### API 文档
- 使用 FastAPI 自动生成的文档
- 重要接口添加使用示例

